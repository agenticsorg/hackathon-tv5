# HAProxy Configuration for Omega Constellation gRPC Load Balancing

global
    log stdout format raw local0
    maxconn 50000
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5s
    timeout client  300s
    timeout server  300s
    timeout tunnel  3600s

# Stats interface
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 10s
    stats admin if TRUE

# gRPC frontend
frontend grpc_frontend
    bind *:50051
    mode tcp
    option tcplog
    default_backend grpc_constellation

# gRPC backend - constellation servers
backend grpc_constellation
    mode tcp
    balance leastconn
    option tcp-check

    # Health check
    tcp-check connect

    # Server pool (adjust IPs for your environment)
    server constellation-1 constellation:50051 check inter 2s rise 2 fall 3 maxconn 5000
    server constellation-2 constellation:50051 check inter 2s rise 2 fall 3 maxconn 5000
    server constellation-3 constellation:50051 check inter 2s rise 2 fall 3 maxconn 5000
    server constellation-4 constellation:50051 check inter 2s rise 2 fall 3 maxconn 5000
    server constellation-5 constellation:50051 check inter 2s rise 2 fall 3 maxconn 5000
    server constellation-6 constellation:50051 check inter 2s rise 2 fall 3 maxconn 5000
    server constellation-7 constellation:50051 check inter 2s rise 2 fall 3 maxconn 5000
    server constellation-8 constellation:50051 check inter 2s rise 2 fall 3 maxconn 5000
    server constellation-9 constellation:50051 check inter 2s rise 2 fall 3 maxconn 5000
    server constellation-10 constellation:50051 check inter 2s rise 2 fall 3 maxconn 5000
