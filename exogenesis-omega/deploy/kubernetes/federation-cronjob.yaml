apiVersion: batch/v1
kind: CronJob
metadata:
  name: federation-worker
  namespace: omega-system
  labels:
    app: federation
    component: worker
spec:
  # Run every hour
  schedule: "0 * * * *"

  # Keep last 3 successful and 1 failed job
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1

  # Concurrency policy - don't start new if previous is still running
  concurrencyPolicy: Forbid

  # Deadline for job completion (1 hour)
  startingDeadlineSeconds: 300

  jobTemplate:
    metadata:
      labels:
        app: federation
        component: worker
    spec:
      # Retry failed jobs
      backoffLimit: 3

      # Timeout for job (50 minutes)
      activeDeadlineSeconds: 3000

      template:
        metadata:
          labels:
            app: federation
            component: worker
          annotations:
            prometheus.io/scrape: "true"
            prometheus.io/port: "9091"

        spec:
          restartPolicy: OnFailure

          initContainers:
            - name: wait-for-postgres
              image: busybox:1.36
              command:
                - sh
                - -c
                - |
                  until nc -z ruvector-postgres-primary 5432; do
                    echo "Waiting for RuVector-Postgres..."
                    sleep 5
                  done
                  echo "Database is ready!"

          containers:
            - name: federation-worker
              image: omega/federation-worker:v0.1.0
              imagePullPolicy: IfNotPresent

              ports:
                - name: metrics
                  containerPort: 9091
                  protocol: TCP

              env:
                - name: POSTGRES_URLS
                  valueFrom:
                    secretKeyRef:
                      name: ruvector-postgres-secret
                      key: all_urls

                - name: AGGREGATION_INTERVAL_SECS
                  value: "3600"  # 1 hour

                - name: MIN_QUALITY_THRESHOLD
                  value: "0.8"

                - name: TREND_DECAY_RATE
                  value: "0.95"

                - name: METRICS_ADDR
                  value: "0.0.0.0:9091"

                - name: RUST_LOG
                  value: "info,federation_worker=debug"

                - name: JOB_START_TIME
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.creationTimestamp

                - name: POD_NAME
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.name

              resources:
                requests:
                  cpu: "4"
                  memory: "16Gi"
                  ephemeral-storage: "10Gi"
                limits:
                  cpu: "8"
                  memory: "32Gi"
                  ephemeral-storage: "20Gi"

              # Security context
              securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL

              volumeMounts:
                - name: tmp
                  mountPath: /tmp
                - name: work
                  mountPath: /data/federation

          volumes:
            - name: tmp
              emptyDir: {}
            - name: work
              emptyDir:
                sizeLimit: 10Gi

          serviceAccountName: federation-worker

          terminationGracePeriodSeconds: 60

          securityContext:
            fsGroup: 1000
            runAsNonRoot: true
            seccompProfile:
              type: RuntimeDefault

---
# ServiceAccount for federation worker
apiVersion: v1
kind: ServiceAccount
metadata:
  name: federation-worker
  namespace: omega-system
  labels:
    app: federation
    component: worker

---
# Role for federation worker
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: federation-worker
  namespace: omega-system
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]

---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: federation-worker
  namespace: omega-system
subjects:
  - kind: ServiceAccount
    name: federation-worker
    namespace: omega-system
roleRef:
  kind: Role
  name: federation-worker
  apiGroup: rbac.authorization.k8s.io
